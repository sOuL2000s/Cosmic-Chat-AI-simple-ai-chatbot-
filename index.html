<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Chatbot AI</title>
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="/manifest.json">
    <!-- Google Fonts for a futuristic look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js CDN for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Lucide Icons for a modern, futuristic feel -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /*
         * --- Custom Styles for Cosmic Chatbot AI ---
         * This section defines the AMOLED black and galactic/cosmic theme,
         * ensuring a stunning and user-friendly experience across devices.
         */
        
        /* Basic font and transition settings for the whole page */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.4s ease, color 0.4s ease;
            height: 100vh; /* Ensure full viewport height */
            margin: 0;
            display: flex;
            flex-direction: column;
            overflow-x: hidden; /* Prevent horizontal scroll caused by sidebar */
            
            /* Cosmic Background - Gradient + Starfield */
            background: radial-gradient(circle at top left, #1a0f2b 0%, #000000 70%),
                        radial-gradient(circle at bottom right, #0f1a2b 0%, #000000 70%);
            background-color: #000000; /* Fallback for older browsers */
            background-size: 200% 200%; /* Make gradients larger to cover */
            animation: backgroundPan 60s linear infinite; /* Slow pan for background */
            position: relative; /* For starfield */
            z-index: 0;
        }

        /* CSS Starfield Effect */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 50px 160px, #ddd, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 90px 100px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 130px 190px, #eee, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 160px 120px, #ddd, rgba(0,0,0,0));
            background-repeat: repeat;
            background-size: 200px 200px;
            opacity: 0.3;
            animation: twinkle 10s infinite alternate;
            z-index: -1; /* Behind content */
        }

        @keyframes backgroundPan {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
            100% { background-position: 0% 0%; }
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        /* Defining a vibrant, cosmic color palette using CSS variables */
        :root {
            /* Dark mode (default) colors for AMOLED black and cosmic theme */
            --bg-color-dark: #000000; /* Pure AMOLED black */
            --card-bg-dark: #1a0f2b; /* Deep violet/blue for cards/chat bubbles */
            --text-color-dark: #e0e7ff; /* Light blue-white for main text */
            --border-color-dark: #372a4d; /* Subtle dark border */
            
            /* Light mode colors (if toggled, for contrast) */
            --bg-color-light: #f0f4f8;
            --card-bg-light: #ffffff;
            --text-color-light: #1f2937;
            --border-color-light: #e5e7eb;
            
            /* Accent colors for buttons, highlights, etc. (cosmic vibrancy) */
            --accent-primary: #a78bfa; /* Vibrant purple */
            --accent-secondary: #0ea5e9; /* Electric blue */
            --accent-tertiary: #10b981; /* Glowing green for success */
            --accent-error: #ef4444; /* Clear red for errors */
            --accent-gradient-start: #a78bfa; /* Purple for gradients */
            --accent-gradient-end: #0ea5e9; /* Blue for gradients */
        }
        
        /* Apply colors based on light or dark body class */
        body.light {
            background: var(--bg-color-light);
            color: var(--text-color-light);
        }
        body.light::before {
            display: none; /* Hide starfield in light mode */
        }

        body.dark {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        /* Tailwind overrides for dark mode to ensure consistency */
        body.dark .bg-white { background-color: var(--card-bg-dark); }
        body.dark .bg-gray-50 { background-color: #11091e; } /* Even darker for header/footer */
        body.dark .border-gray-100 { border-color: var(--border-color-dark); }
        body.dark .border-gray-200 { border-color: #2e243f; }
        body.dark .text-gray-800, body.dark .text-gray-900 { color: var(--text-color-dark); }
        body.dark .text-gray-600 { color: #a1a1aa; }
        body.dark .text-gray-700 { color: #c3c3c3; }
        body.dark .bg-gray-200 { background-color: #3f3f46; color: #f4f4f5; }
        body.dark .hover\:bg-gray-300:hover { background-color: #52525b; }
        body.dark .bg-gray-100 { background-color: #271a3d; } /* Darker for message bubbles */
        body.dark .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6); } /* Deeper shadow for AMOLED */
        
        /* Specific overrides for chat elements in dark mode */
        body.dark #chat-history { background-color: rgba(0, 0, 0, 0.6); border-color: #372a4d; } /* Make chat history slightly transparent black */
        body.dark #chat-input { background-color: #1a0f2b; color: var(--text-color-dark); border-color: #372a4d; }
        body.dark #chat-input::placeholder { color: #8e889a; }
        body.dark #model-select, body.dark #temperature-select, body.dark #version-select { 
            background-color: #1a0f2b; 
            color: var(--text-color-dark); 
            border-color: #372a4d; 
            appearance: none; /* Remove default arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a78bfa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.2em;
            padding-right: 2.5rem; /* Make space for custom arrow */
        }
        body.dark #model-select option, body.dark #temperature-select option, body.dark #version-select option { background-color: #1a0f2b; color: var(--text-color-dark); }
        body.dark #sidebar { background-color: #11091e; border-left: 1px solid #372a4d; } /* Sidebar background */

        body.dark .bg-violet-600 { background-color: var(--accent-primary); } /* Changed to violet */
        body.dark .hover\:bg-violet-700:hover { background-color: #8b5cf6; } /* Slightly darker purple on hover */
        body.dark .focus\:ring-violet-300:focus { box-shadow: 0 0 0 4px rgba(167, 139, 250, 0.4); } /* Changed to violet */

        body.dark .bg-gray-400 { background-color: #4a4e58; } /* Darker gray for disabled states */
        body.dark .text-gray-400 { color: #9ca3af; } /* Lighter gray for disabled text */
        
        /* Custom styles for glowing effects on buttons and borders */
        .glow-button {
            position: relative;
            z-index: 10;
            transition: all 0.4s ease;
            box-shadow: 0 0 10px var(--accent-primary);
        }
        .glow-button:hover {
            box-shadow: 0 0 15px var(--accent-primary), 0 0 25px var(--accent-primary), 0 0 35px var(--accent-primary);
            transform: translateY(-2px);
        }
        .glow-border {
            box-shadow: 0 0 10px rgba(167, 139, 250, 0.5); /* Semi-transparent glow with primary accent */
        }

        /* NEW: Icon Glow for SVGs */
        .icon-glow {
            filter: drop-shadow(0 0 8px var(--accent-primary)) drop-shadow(0 0 15px rgba(167, 139, 250, 0.4));
            transition: filter 0.3s ease;
        }

        /* Header Title Gradient */
        .cosmic-title {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(45deg, var(--accent-gradient-start), var(--accent-gradient-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent; /* Fallback */
            text-shadow: 0 0 15px rgba(167, 139, 250, 0.6); /* Subtle text glow */
        }
        .cosmic-subtitle {
            font-family: 'Inter', sans-serif;
            color: #a1a1aa; /* Lighter gray for subtitle */
        }
        
        /* Markdown content styling for better readability */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { 
            font-weight: bold; 
            margin-bottom: 0.75em; 
            margin-top: 1.5em; 
            line-height: 1.2; 
            color: var(--accent-secondary); 
            font-family: 'Orbitron', sans-serif; /* Headings use Orbitron */
        }
        .markdown-content h1 { font-size: 2.25rem; }
        .markdown-content h2 { font-size: 1.875rem; }
        .markdown-content h3 { font-size: 1.5rem; }
        .markdown-content ul, .markdown-content ol { list-style-position: inside; margin-left: 1.5em; margin-bottom: 1em; }
        .markdown-content li { margin-bottom: 0.5em; }
        .markdown-content strong { color: var(--accent-primary); }
        .markdown-content code {
            background-color: rgba(167, 139, 250, 0.1);
            color: var(--accent-primary);
            padding: 0.2em 0.4em;
            border-radius: 0.3em;
            font-family: 'Fira Code', 'Monaco', 'Consolas', 'monospace';
            font-size: 0.9em;
        }
        .markdown-content pre {
            background-color: rgba(0, 0, 0, 0.4); /* Darker for code blocks */
            border-radius: 0.5rem;
            padding: 1em;
            overflow-x: auto;
            margin-top: 1em;
            margin-bottom: 1em;
            position: relative; /* Needed for absolute positioning of copy button */
            border: 1px solid rgba(167, 139, 250, 0.2); /* Subtle border for code blocks */
        }
        .markdown-content pre code {
            background-color: transparent;
            color: #d4d4d8; /* Light grey for code */
            padding: 0;
            font-size: 1em;
        }
        .markdown-content blockquote {
            border-left: 4px solid var(--accent-secondary);
            color: #b0b0b0;
            padding-left: 1em;
            margin: 1em 0;
            font-style: italic;
        }

        /* Custom styles for dark mode toggle switch */
        .slider {
            background-color: #d1d5db;
            transition: .4s;
        }
        .dark .slider {
            background-color: #4b5563;
        }
        .slider:before {
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: var(--accent-secondary);
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* Custom scrollbar for a sleek look */
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: #1a0f2b; border-radius: 4px; } /* Match card-bg-dark */
        #chat-history::-webkit-scrollbar-thumb { background: #4a3a6b; border-radius: 4px; } /* Slightly lighter purple */
        #chat-history::-webkit-scrollbar-thumb:hover { background: #6b5a8c; } /* Even lighter on hover */
        
        /* Modern loading animation */
        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .loader-dot {
            width: 12px;
            height: 12px;
            margin: 0 4px;
            background-color: var(--accent-primary);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loader-dot:nth-child(1) { animation-delay: -0.32s; }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; }
        .loader-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }
        
        /* Chat message styles */
        .chat-message {
            margin-bottom: 0.75rem; /* 12px */
            padding: 1rem; /* 16px */
            border-radius: 1.5rem; /* 24px */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            word-break: break-word;
            transition: all 0.3s ease;
            transform: scale(0.95);
            transform-origin: bottom;
            max-width: 85%;
            line-height: 1.5;
            position: relative; /* For action buttons */
        }

        .chat-message.user {
            background-color: #372a4d; /* Darker violet for user */
            color: #d1c0ed; /* Lighter purple for user text */
            margin-left: auto;
            border-top-left-radius: 1.5rem;
            border-bottom-right-radius: 0.5rem; /* 8px */
            border: 1px solid rgba(167, 139, 250, 0.2);
            box-shadow: 0 0 15px rgba(167, 139, 250, 0.15);
        }
        .chat-message.ai {
            background-color: rgba(26, 15, 43, 0.8); /* Deep violet for AI with transparency */
            backdrop-filter: blur(5px); /* Holographic effect */
            color: var(--text-color-dark);
            margin-right: auto;
            border-top-right-radius: 1.5rem;
            border-bottom-left-radius: 0.5rem; /* 8px */
            border: 1px solid rgba(14, 165, 233, 0.2);
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.15);
            padding-bottom: 3.5rem; /* Space for action buttons */
        }
        body.light .chat-message.user {
            background-color: #e0f2fe; /* Light blue */
            color: #1e40af; /* Dark blue */
            border: none;
            box-shadow: none;
        }
        body.light .chat-message.ai {
            background-color: #f3f4f6; /* Light gray */
            color: #374151; /* Dark gray */
            border: none;
            box-shadow: none;
            backdrop-filter: none;
        }

        /* Styling for chat attachments */
        .chat-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            margin-top: 0.5rem;
            display: block;
            border: 1px solid var(--border-color-dark);
        }
        
        /* Styling for the copy message */
        #copy-message {
            position: fixed;
            bottom: 6rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            background-color: var(--accent-tertiary);
            color: white;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease-in-out;
            z-index: 100;
        }

        #copy-message.show {
            opacity: 1;
            visibility: visible;
        }

        /* Ensure main content takes available height */
        .main-chat-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* Allow it to grow and fill space */
            padding: 0 1rem; /* Reduced horizontal padding on main container */
            max-width: 100%;
            overflow: hidden; /* Prevent horizontal scroll */
        }

        /* Sidebar specific styles */
        #sidebar {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: 280px; /* Adjust width as needed */
            background-color: #11091e; /* Darker background for sidebar */
            z-index: 50;
            transform: translateX(100%); /* Start off-screen */
            transition: transform 0.3s ease-in-out;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
            padding: 1.5rem; /* Increased padding */
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Increased gap */
            overflow-y: auto; /* Allow scrolling if content is long */
            border-left: 1px solid #372a4d;
        }

        #sidebar.open {
            transform: translateX(0); /* Slide in */
        }

        #sidebar-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7); /* Dark overlay */
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        #sidebar-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive adjustments for header/footer */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: row; /* Keep header items in a row on mobile */
                justify-content: space-between; /* Space out title and hamburger */
                align-items: center;
            }
            .header-content .text-center { /* Adjust title alignment */
                text-align: left;
                margin-bottom: 0;
            }
            .header-content .text-center h1 {
                justify-content: flex-start;
            }
            .header-content .text-center p {
                display: none; /* Hide subtitle on very small screens */
            }
            /* Hide desktop controls on mobile */
            #desktop-controls-container {
                display: none;
            }
            /* Show hamburger button on mobile */
            #open-sidebar-btn {
                display: flex;
            }
            /* Adjust sidebar width for smaller screens if needed */
            #sidebar {
                width: 75%; /* Take 75% of screen width on small devices */
                max-width: 280px; /* But don't exceed 280px */
            }

            /* Reduce padding on the input container for smaller screens */
            .input-area-container {
                padding: 0.5rem; /* p-2 */
            }
            /* Ensure the chat input can shrink further */
            #chat-input {
                min-width: 0; /* Allow flex item to shrink below its content size */
            }
            /* Specific styling for controls when they are in the sidebar */
            .sidebar-controls-group .model-selector-group,
            .sidebar-controls-group .temperature-selector-group,
            .sidebar-controls-group .version-selector-group,
            .sidebar-controls-group .dark-mode-toggle-container {
                flex-direction: column; /* Stack label and select/toggle */
                align-items: flex-start; /* Align to left in sidebar */
                width: 100%;
            }
            .sidebar-controls-group .model-selector-group label,
            .sidebar-controls-group .temperature-selector-group label,
            .sidebar-controls-group .version-selector-group label {
                margin-bottom: 0.5rem;
                margin-right: 0; /* Remove desktop margin */
            }
            .sidebar-controls-group .model-selector-group select,
            .sidebar-controls-group .temperature-selector-group select,
            .sidebar-controls-group .version-selector-group select {
                width: 100%; /* Make select full width in sidebar */
            }
            .sidebar-controls-group .dark-mode-toggle-container {
                justify-content: flex-start; /* Align to left in sidebar */
            }
        }

        /* Styles for AI message action buttons (copy, feedback) */
        .ai-actions {
            position: absolute;
            bottom: 0.75rem; /* 12px from bottom */
            right: 1rem; /* 16px from right */
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        .ai-actions button {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.4rem 0.6rem;
            border-radius: 9999px;
            color: #d1d5db;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s ease;
        }
        .ai-actions button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-1px);
        }
        .ai-actions button.liked {
            background-color: var(--accent-tertiary);
            border-color: var(--accent-tertiary);
            color: white;
        }
        .ai-actions button.disliked {
            background-color: var(--accent-error);
            border-color: var(--accent-error);
            color: white;
        }

        /* Style for the "Copy Code" button within <pre> blocks */
        .code-copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(255, 255, 255, 0.15);
            color: #d1d5db;
            padding: 0.25rem 0.6rem;
            border-radius: 0.3rem;
            font-size: 0.8rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            z-index: 20; /* Ensure it's above code content */
        }
        .code-copy-btn:hover {
            background-color: rgba(255, 255, 255, 0.25);
            color: white;
        }
        body.light .code-copy-btn {
            background-color: rgba(0, 0, 0, 0.08);
            color: #374151;
        }
        body.light .code-copy-btn:hover {
            background-color: rgba(0, 0, 0, 0.15);
            color: #1f2937;
        }

        /* Styles for voice input button and active state */
        .voice-input-btn.active {
            background-color: var(--accent-secondary); /* Electric blue when active */
            box-shadow: 0 0 15px var(--accent-secondary), 0 0 25px var(--accent-secondary), 0 0 35px var(--accent-secondary);
            animation: pulse-mic 1.5s infinite ease-in-out;
        }

        @keyframes pulse-mic {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(14, 165, 233, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }
        }

        /* Input area gradient */
        .input-area-container {
            background: linear-gradient(to top, #11091e, #1a0f2b);
            border-top: 1px solid #372a4d;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.4);
        }
        .header-content {
            background: linear-gradient(to bottom, #11091e, #1a0f2b);
            border-bottom: 1px solid #372a4d;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body class="antialiased dark">

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="md:hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-50 font-orbitron">Settings</h2>
            <button id="close-sidebar-btn" class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-gray-700 transition-colors" aria-label="Close sidebar">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <!-- Mobile Controls Placeholder - Controls will be moved here by JS -->
        <div id="mobile-controls-placeholder" class="flex flex-col gap-6 sidebar-controls-group">
            <!-- Controls will be dynamically inserted here -->
        </div>
    </aside>

    <!-- Main container for the full-screen chatbot -->
    <div class="main-chat-container max-w-4xl mx-auto w-full bg-transparent">
            
        <!-- Header Section with Title, Dark Mode Toggle, Model Selector, and Temperature Selector -->
        <header class="header-content flex flex-col md:flex-row justify-between items-center px-4 md:px-6 py-4 rounded-t-xl mb-4">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <h1 class="text-3xl md:text-4xl font-extrabold cosmic-title tracking-tight flex items-center justify-center md:justify-start">
                    <!-- MODIFIED: Removed glow-button, added icon-glow -->
                    <i data-lucide="sparkles" class="w-8 h-8 md:w-10 md:h-10 text-violet-400 mr-2 animate-pulse icon-glow"></i>
                    Cosmic Chat AI
                </h1>
                <p class="text-md md:text-lg cosmic-subtitle mt-1">
                    Your intelligent companion across the digital cosmos.
                </p>
            </div>
            
            <!-- Hamburger Menu Button (Mobile Only) -->
            <button id="open-sidebar-btn" class="md:hidden flex items-center justify-center w-10 h-10 rounded-full bg-gray-700 text-gray-200 shadow-lg hover:bg-gray-600 transition-all duration-300" aria-label="Open sidebar menu">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>

            <!-- Desktop Controls Container - Controls will be moved here by JS on desktop -->
            <div id="desktop-controls-container" class="hidden md:flex md:flex-row md:flex-wrap md:justify-end md:w-auto md:items-center gap-4 mt-4 md:mt-0 header-controls-group">
                <!-- Controls will be dynamically inserted here by JavaScript -->
            </div>
        </header>

        <!-- Chat history div with a minimum height and scroll -->
        <div id="chat-history" class="p-4 overflow-y-auto flex-1 flex flex-col rounded-b-xl border bg-black shadow-inner-xl mb-4">
            <div class="flex flex-col items-center justify-center h-full text-center text-gray-500 dark:text-gray-600 mb-8 initial-message">
                <i data-lucide="message-circle" class="w-16 h-16 mb-4 text-violet-500"></i>
                <p class="text-lg font-semibold">Start your cosmic journey by sending a message!</p>
                <p class="text-sm mt-2">You can ask questions, upload files, or just say hello.</p>
            </div>
        </div>
        
        <!-- Chat input section with attachment and send button -->
        <div class="input-area-container p-2 sm:p-4 rounded-xl mt-auto">
            <!-- Attachment preview -->
            <div id="chat-attachments-preview-container" class="mb-2 flex flex-wrap items-center gap-2 hidden">
                <!-- Attachments previews will be dynamically added here -->
            </div>
            <div class="flex gap-2">
                <input type="file" id="chat-file-upload" accept="*" class="hidden" multiple aria-label="File upload input">
                <input type="text" id="chat-input" class="flex-1 p-3 rounded-full border focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition-colors shadow-sm dark:bg-gray-900 dark:border-gray-700 dark:text-white" placeholder="Ask your cosmic question..." aria-label="Chat input field">
                <label for="chat-file-upload" class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-700 text-gray-200 shadow-lg hover:bg-gray-600 cursor-pointer transition-all duration-300 flex-shrink-0" aria-label="Attach files">
                    <i data-lucide="paperclip" class="w-5 h-5"></i>
                </label>
                
                <!-- Voice Input Button -->
                <button id="voice-input-btn" aria-label="Toggle voice input" class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-700 text-gray-200 shadow-lg hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 flex-shrink-0">
                    <i data-lucide="mic" class="w-5 h-5"></i>
                </button>

                <button id="send-chat-btn" aria-label="Send Message" class="flex items-center justify-center w-12 h-12 rounded-full bg-violet-600 text-white shadow-lg hover:bg-violet-700 focus:outline-none focus:ring-4 focus:ring-violet-300 transition-all duration-300 disabled:bg-violet-400 disabled:cursor-not-allowed glow-button flex-shrink-0" style="--accent-primary: var(--accent-primary);">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Footer Section -->
    <footer class="text-center text-gray-600 dark:text-gray-500 text-xs py-2 px-4 mt-auto">
        <p>&copy; 2025 Cosmic Chat AI. All rights reserved.</p>
        <p class="mt-0.5">Powered by Gemini AI</p>
    </footer>

    <!-- Temporary message for clipboard copy -->
    <div id="copy-message" aria-live="polite">Text copied to clipboard!</div>

    <!-- Hidden controls template that will be moved by JS -->
    <template id="hidden-controls-template">
        <!-- Model Selection -->
        <div class="flex items-center model-selector-group">
            <label for="model-select" class="mr-2 text-gray-400 text-sm">Model:</label>
            <select id="model-select" class="p-2 rounded-md border text-sm focus:ring-violet-500 focus:border-violet-500" aria-label="Select AI Model">
                <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Latest)</option>
                <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro (Latest)</option>
                <option value="gemini-2.5-flash-preview-09-2025" selected>Gemini 2.5 Flash (Preview 09-25)</option>
                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
                <option value="gemini-2.5-flash-lite-06-17">Gemini 2.5 Flash Lite (06-17)</option>
                <option value="gemini-2.0-flash-preview-image-generation">Gemini 2.0 Flash (Image Gen Preview)</option>
                <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                <option value="gemini-2.0-flash-001">Gemini 2.0 Flash (001)</option>
                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Experimental)</option>
            </select>
        </div>

        <!-- Creativity Temperature Selection -->
        <div class="flex items-center temperature-selector-group">
            <label for="temperature-select" class="mr-2 text-gray-400 text-sm">Creativity:</label>
            <select id="temperature-select" class="p-2 rounded-md border text-sm focus:ring-violet-500 focus:border-violet-500" aria-label="Select AI creativity temperature">
                <option value="0.0" selected>0.0 (Factual)</option>
                <option value="0.3">0.3</option>
                <option value="0.5">0.5 (Default)</option>
                <option value="0.7">0.7</option>
                <option value="0.8">0.8</option>
                <option value="0.9">0.9</option>
                <option value="1.0">1.0 (Creative)</option>
            </select>
        </div>

        <!-- Version Selector -->
        <div class="flex items-center version-selector-group">
            <label for="version-select" class="mr-2 text-gray-400 text-sm">Version:</label>
            <select id="version-select" class="p-2 rounded-md border text-sm focus:ring-violet-500 focus:border-violet-500" aria-label="Select Chatbot Version">
                <option value="https://mystic-vision-ai-standalone-chatbot.netlify.app/">Main Version</option>
                <option value="https://mystic-vision-ai-lite.netlify.app/">Lite Version</option>
                <option value="https://mystic-vision-ai-basic.netlify.app/">Basic Version</option>
                <option value="https://mystic-vision-ai-mini.netlify.app/">Mini Version</option>
                <option value="https://cosmic-chat-ai-simple-ai-chatbot.netlify.app/" selected>Cosmic Chat AI (Current)</option>
                <option value="https://small-ai-big-vision.netlify.app/">Small AI</option>
                <option value="https://small-ai-big-vision-v2.netlify.app/">Small AI v2</option>
            </select>
        </div>

        <!-- Dark Mode Toggle -->
        <div class="flex items-center space-x-2 dark-mode-toggle-container">
            <span class="text-gray-400 text-sm">Light</span>
            <label class="switch relative inline-block w-14 h-8" aria-label="Toggle dark mode">
                <input type="checkbox" id="dark-mode-toggle" class="opacity-0 w-0 h-0">
                <span class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 rounded-full before:absolute before:content-[''] before:h-6 before:w-6 before:left-1 before:bottom-1 before:rounded-full"></span>
            </label>
            <span class="text-gray-400 text-sm">Dark</span>
        </div>
    </template>


    <script type="text/javascript">
        // JavaScript for handling chat functionality and API interaction
        
        // This function call is from the Lucide Icon library to replace all `<i>` tags with the corresponding SVG icons
        const createIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        window.addEventListener('load', () => {
             // Create icons on initial page load for the main UI
             createIcons();
        });

        // Chat elements
        const chatHistoryDiv = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const chatFileUpload = document.getElementById('chat-file-upload');
        const chatAttachmentsPreviewContainer = document.getElementById('chat-attachments-preview-container');
        
        // Sidebar elements
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const openSidebarBtn = document.getElementById('open-sidebar-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');

        // Control containers
        const desktopControlsContainer = document.getElementById('desktop-controls-container');
        const mobileControlsPlaceholder = document.getElementById('mobile-controls-placeholder');
        const hiddenControlsTemplate = document.getElementById('hidden-controls-template');

        // Clone each control group individually from the template content
        // This ensures we have distinct elements to move around
        const modelSelectorGroup = hiddenControlsTemplate.content.querySelector('.model-selector-group').cloneNode(true);
        const temperatureSelectorGroup = hiddenControlsTemplate.content.querySelector('.temperature-selector-group').cloneNode(true);
        const versionSelectorGroup = hiddenControlsTemplate.content.querySelector('.version-selector-group').cloneNode(true);
        const darkModeToggleContainer = hiddenControlsTemplate.content.querySelector('.dark-mode-toggle-container').cloneNode(true);

        // Append them to the desktop container initially
        // This makes them part of the live DOM so getElementById can find them
        desktopControlsContainer.appendChild(modelSelectorGroup);
        desktopControlsContainer.appendChild(temperatureSelectorGroup);
        desktopControlsContainer.appendChild(versionSelectorGroup);
        desktopControlsContainer.appendChild(darkModeToggleContainer);

        // Get references to the actual control elements *after* they are in the DOM
        const modelSelect = document.getElementById('model-select');
        const temperatureSelect = document.getElementById('temperature-select');
        const versionSelect = document.getElementById('version-select');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        
        // Copy message element
        const copyMessage = document.getElementById('copy-message');

        // Voice Input elements
        const voiceInputBtn = document.getElementById('voice-input-btn');
        let recognition; // SpeechRecognition object
        let isListening = false;
        let finalTranscript = ''; // Stores the accumulated final transcript

        let chatAttachments = []; // Array to store {file: File, mimeType: string, data: string, name: string} for chat
        let chatHistory = []; // Stores the full conversation for context

        // Gemini API Configuration
        // WARNING: Hardcoding API keys in client-side code is NOT recommended for production environments
        // as it exposes your key to anyone who inspects your page. For a production-grade app,
        // you should proxy your API requests through a secure backend server.
        const GEMINI_API_KEY = "AIzaSyCzx6ReMk8ohPJcCjGwHHzu7SvFccJqAbA"; 
        
        // Initialize GEMINI_MODEL from the default selected option in the HTML
        let GEMINI_MODEL = modelSelect.value; 
        // Initialize GEMINI_TEMPERATURE from the default selected option in the HTML
        let GEMINI_TEMPERATURE = parseFloat(temperatureSelect.value);

        if (GEMINI_API_KEY === "" || !GEMINI_API_KEY) {
            console.error("API Key is not set. Please replace 'AIzaSyCzx6ReMk8ohPJcCjGwHHzu7SvFccJqAbA' with your actual API key.");
            // Display a more prominent error if API key is missing
            const apiKeyError = document.createElement('div');
            apiKeyError.classList.add('chat-message', 'ai', 'bg-red-800', 'text-red-100', 'border-red-600', 'my-4');
            apiKeyError.innerHTML = `<span class="font-bold"><i data-lucide="alert-triangle" class="w-4 h-4 mr-1 inline-block"></i> Critical Error:</span> Gemini API Key is missing or invalid. Please check the 'GEMINI_API_KEY' variable in the script. Chat functionality is disabled.`;
            chatHistoryDiv.insertBefore(apiKeyError, chatHistoryDiv.firstChild);
            chatHistoryDiv.scrollTop = 0; // Show error at top
            createIcons();

            sendChatBtn.disabled = true;
            chatInput.disabled = true;
            chatFileUpload.disabled = true;
            modelSelect.disabled = true; // Disable model selection if API key is bad
            temperatureSelect.disabled = true; // Disable temperature selection too
            versionSelect.disabled = true; // Disable version selection too
            darkModeToggle.disabled = true; // Disable dark mode toggle
        }

        // Dark Mode Initialization and Listener
        // Set dark mode as default if not already set in local storage
        if (localStorage.getItem('dark-mode') === null) {
            localStorage.setItem('dark-mode', 'true');
        }
        
        const isDarkMode = localStorage.getItem('dark-mode') === 'true';
        if (isDarkMode) {
            document.body.classList.add('dark');
            darkModeToggle.checked = true;
        } else {
            document.body.classList.remove('dark');
            darkModeToggle.checked = false;
        }

        darkModeToggle.addEventListener('change', () => {
            if (darkModeToggle.checked) {
                document.body.classList.add('dark');
                localStorage.setItem('dark-mode', 'true');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem('dark-mode', 'false');
            }
        });

        // Event listener for model selection change
        modelSelect.addEventListener('change', (event) => {
            GEMINI_MODEL = event.target.value;
            console.log(`Gemini model changed to: ${GEMINI_MODEL}`);
        });

        // Event listener for temperature selection change
        temperatureSelect.addEventListener('change', (event) => {
            GEMINI_TEMPERATURE = parseFloat(event.target.value);
            console.log(`Gemini creativity temperature changed to: ${GEMINI_TEMPERATURE}`);
        });

        // Event listener for version selection change
        versionSelect.addEventListener('change', (event) => {
            const selectedUrl = event.target.value;
            if (selectedUrl) {
                window.location.href = selectedUrl;
            }
        });

        // --- Sidebar Functions ---
        function openSidebar() {
            sidebar.classList.add('open');
            sidebarOverlay.classList.add('open');
            document.body.style.overflow = 'hidden'; // Prevent scrolling main content
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('open');
            document.body.style.overflow = ''; // Restore scrolling
        }

        openSidebarBtn.addEventListener('click', openSidebar);
        closeSidebarBtn.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar); // Close sidebar when clicking overlay

        // --- Responsive Controls Placement ---
        const MOBILE_BREAKPOINT = 768; // Tailwind's 'md' breakpoint

        function handleControlsPlacement() {
            if (window.innerWidth < MOBILE_BREAKPOINT) {
                // Move controls to sidebar if they are not already there
                if (modelSelectorGroup.parentNode !== mobileControlsPlaceholder) {
                    mobileControlsPlaceholder.appendChild(modelSelectorGroup);
                    mobileControlsPlaceholder.appendChild(temperatureSelectorGroup);
                    mobileControlsPlaceholder.appendChild(versionSelectorGroup);
                    mobileControlsPlaceholder.appendChild(darkModeToggleContainer);
                }
            } else {
                // Move controls to desktop header if they are not already there
                if (modelSelectorGroup.parentNode !== desktopControlsContainer) {
                    desktopControlsContainer.appendChild(modelSelectorGroup);
                    desktopControlsContainer.appendChild(temperatureSelectorGroup);
                    desktopControlsContainer.appendChild(versionSelectorGroup);
                    desktopControlsContainer.appendChild(darkModeToggleContainer);
                    closeSidebar(); // Ensure sidebar is closed on desktop
                }
            }
            createIcons(); // Re-render icons after moving elements
        }

        // Call on load and resize
        window.addEventListener('load', handleControlsPlacement);
        window.addEventListener('resize', handleControlsPlacement);


        // Function to convert a file to a Base64 string and return its MIME type and data
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({
                    mimeType: file.type || 'application/octet-stream', // Fallback MIME type
                    data: reader.result.split(',')[1]
                });
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        // Function to get Lucide icon name based on MIME type
        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'image';
            if (mimeType === 'application/pdf') return 'file-text';
            if (mimeType.includes('text/plain') || mimeType.includes('text/markdown')) return 'file-text';
            if (mimeType.includes('csv') || mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'file-spreadsheet';
            if (mimeType.includes('json') || mimeType.includes('xml') || mimeType.includes('code')) return 'file-code';
            if (mimeType.includes('audio/')) return 'file-audio';
            if (mimeType.includes('video/')) return 'file-video';
            if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('tar')) return 'file-archive';
            return 'file'; // Generic file icon
        }

        // Function to display an error message (for critical errors)
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.classList.add('chat-message', 'ai', 'bg-red-800', 'text-red-100', 'border-red-600');
            errorDiv.innerHTML = `<span class="font-bold"><i data-lucide="alert-triangle" class="w-4 h-4 mr-1 inline-block"></i> Error:</span> ${message}`;
            chatHistoryDiv.appendChild(errorDiv);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            createIcons(); // Ensure error icon is rendered
        }

        // Helper to copy text to clipboard
        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(() => {
                showCopyMessage();
                if (element) {
                    const originalText = element.innerHTML;
                    element.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Copied!`;
                    createIcons();
                    setTimeout(() => {
                        element.innerHTML = originalText;
                        createIcons();
                    }, 2000);
                }
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }
        
        // Function to append a message to the chat history
        function appendChatMessage(role, text, attachments = [], messageId = null) {
            // Remove the initial prompt if it exists
            const initialPromptDiv = chatHistoryDiv.querySelector('.initial-message');
            if (initialPromptDiv) {
                initialPromptDiv.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', role);
            
            let contentHTML = '';

            if (role === 'user') {
                contentHTML += `<span class="font-bold">You:</span> ${text}`;
                if (attachments.length > 0) {
                    contentHTML += `<div class="mt-2 flex flex-wrap gap-2">`;
                    attachments.forEach(attachment => {
                        if (attachment.mimeType.startsWith('image/')) {
                            contentHTML += `<img src="data:${attachment.mimeType};base64,${attachment.data}" alt="${attachment.name || 'User attachment'}" class="chat-image w-24 h-24 object-cover">`;
                        } else {
                            // For non-image files, display an icon and file name
                            contentHTML += `
                                <div class="flex items-center space-x-1 p-2 bg-gray-600 dark:bg-gray-700 rounded-md text-sm">
                                    <i data-lucide="${getFileIcon(attachment.mimeType)}" class="w-4 h-4 flex-shrink-0 text-gray-300"></i>
                                    <span class="truncate max-w-[120px]">${attachment.name || 'File'}</span>
                                </div>
                            `;
                        }
                    });
                    contentHTML += `</div>`;
                }
            } else { // AI message (as a "card")
                const parsedMarkdown = marked.parse(text);
                contentHTML = `
                    <div class="markdown-content">
                        ${parsedMarkdown}
                    </div>
                    <div class="ai-actions mt-2">
                        <button class="copy-ai-response-btn" aria-label="Copy AI response">
                            <i data-lucide="copy" class="w-4 h-4"></i> Copy
                        </button>
                        <button class="feedback-btn like-btn" data-message-id="${messageId}" data-rating="like" aria-label="Like this response">
                            <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                        </button>
                        <button class="feedback-btn dislike-btn" data-message-id="${messageId}" data-rating="dislike" aria-label="Dislike this response">
                            <i data-lucide="thumbs-down" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = contentHTML;
            chatHistoryDiv.appendChild(messageDiv);
            
            // Animate message pop-in
            setTimeout(() => {
                messageDiv.style.transform = 'scale(1)';
            }, 10);
            
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            
            // Call createIcons() after adding new content to the chat history
            createIcons();

            // Add event listeners for new AI message actions
            if (role === 'ai') {
                const copyBtn = messageDiv.querySelector('.copy-ai-response-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => copyToClipboard(text, copyBtn));
                }

                messageDiv.querySelectorAll('.feedback-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const targetBtn = e.currentTarget;
                        const rating = targetBtn.dataset.rating;
                        const messageId = targetBtn.dataset.messageId;

                        // Toggle active state
                        targetBtn.classList.toggle(`${rating}d`);
                        
                        // Ensure only one feedback button is active at a time
                        messageDiv.querySelectorAll('.feedback-btn').forEach(otherBtn => {
                            if (otherBtn !== targetBtn) {
                                otherBtn.classList.remove('liked', 'disliked');
                            }
                        });

                        // For a real app, you'd send this feedback to a backend:
                        console.log(`Feedback for message ${messageId}: ${rating}`);
                        // sendFeedback(messageId, rating);
                    });
                });

                // Add "Copy Code" buttons to pre blocks
                messageDiv.querySelectorAll('.markdown-content pre').forEach((preBlock) => {
                    const codeBlock = preBlock.querySelector('code');
                    if (codeBlock) {
                        const copyCodeBtn = document.createElement('button');
                        copyCodeBtn.classList.add('code-copy-btn');
                        copyCodeBtn.innerHTML = `<i data-lucide="copy" class="w-4 h-4"></i> Copy Code`;
                        copyCodeBtn.setAttribute('aria-label', 'Copy code to clipboard');
                        preBlock.appendChild(copyCodeBtn);
                        createIcons(); // Re-render icons after adding button

                        copyCodeBtn.addEventListener('click', () => {
                            copyToClipboard(codeBlock.textContent, copyCodeBtn);
                        });
                    }
                });
            }
        }

        // Event listener for chat file upload input
        chatFileUpload.addEventListener('change', async (event) => {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                for (const file of files) {
                    try {
                        const { mimeType, data } = await fileToBase64(file);
                        chatAttachments.push({ file, mimeType, data, name: file.name });
                    } catch (error) {
                        showError(`Failed to read chat file ${file.name}.`);
                        console.error('Chat file read error:', error);
                    }
                }
                displayChatAttachments();
                chatInput.focus();
            }
        });

        // Function to display chat attachments
        function displayChatAttachments() {
            chatAttachmentsPreviewContainer.innerHTML = '';
            if (chatAttachments.length > 0) {
                chatAttachmentsPreviewContainer.classList.remove('hidden');
                chatAttachments.forEach((attachment, index) => {
                    const attachmentDiv = document.createElement('div');
                    attachmentDiv.classList.add('flex', 'items-center', 'gap-1', 'p-2', 'rounded-md', 'bg-gray-700', 'text-gray-200', 'text-sm', 'border', 'border-gray-600');
                    attachmentDiv.dataset.index = index;

                    let previewContent = '';
                    if (attachment.mimeType.startsWith('image/')) {
                        previewContent = `<img src="data:${attachment.mimeType};base64,${attachment.data}" alt="${attachment.name}" class="w-10 h-10 object-cover rounded-md">`;
                    } else {
                        previewContent = `<i data-lucide="${getFileIcon(attachment.mimeType)}" class="w-5 h-5 flex-shrink-0 text-gray-300"></i>`;
                    }

                    attachmentDiv.innerHTML = `
                        ${previewContent}
                        <span class="truncate max-w-[100px]">${attachment.name}</span>
                        <button class="remove-attachment-btn text-gray-400 hover:text-white transition-colors p-1 rounded-full hover:bg-gray-600 ml-1" aria-label="Remove ${attachment.name}">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    `;
                    chatAttachmentsPreviewContainer.appendChild(attachmentDiv);
                });
                createIcons(); // Re-render icons for new attachments
            } else {
                chatAttachmentsPreviewContainer.classList.add('hidden');
            }
        }

        // Event listener for removing individual chat attachments
        chatAttachmentsPreviewContainer.addEventListener('click', (event) => {
            if (event.target.closest('.remove-attachment-btn')) {
                const attachmentDiv = event.target.closest('[data-index]');
                if (attachmentDiv) {
                    const index = parseInt(attachmentDiv.dataset.index);
                    chatAttachments.splice(index, 1); // Remove from array
                    displayChatAttachments(); // Re-render preview
                    chatInput.focus();
                }
            }
        });

        // Event listener for sending chat messages
        sendChatBtn.addEventListener('click', async () => {
            if (sendChatBtn.disabled) return; // Prevent double clicks during processing

            // Stop voice input if active before sending
            if (isListening) {
                recognition.stop();
            }

            const userMessage = chatInput.value.trim();
            if (!userMessage && chatAttachments.length === 0) {
                return;
            }
            
            // Build the parts for the user message
            const userParts = [];
            if (userMessage) {
                userParts.push({ text: userMessage });
            }
            const currentAttachments = [...chatAttachments]; // Capture current attachments
            currentAttachments.forEach(attachment => {
                userParts.push({
                    inlineData: {
                        mimeType: attachment.mimeType,
                        data: attachment.data
                    }
                });
            });

            // Append user message and attachments to chat history and UI
            chatHistory.push({ role: 'user', parts: userParts });
            appendChatMessage('user', userMessage, currentAttachments); // Pass captured attachments
            
            // Clear input and attachment after sending
            chatInput.value = '';
            chatAttachments = [];
            chatFileUpload.value = ''; // Clear file input
            displayChatAttachments(); // Clear attachment previews
            
            sendChatBtn.disabled = true;
            chatInput.disabled = true;
            chatFileUpload.disabled = true;
            modelSelect.disabled = true; // Disable model selection during API call
            temperatureSelect.disabled = true; // Disable temperature selection
            versionSelect.disabled = true; // Disable version selection
            darkModeToggle.disabled = true; // Disable dark mode toggle
            voiceInputBtn.disabled = true; // Disable voice input during API call
            
            // Show loading indicator
            const loadingMessage = document.createElement('div');
            loadingMessage.id = 'chat-loading';
            loadingMessage.classList.add('chat-message', 'ai', 'flex', 'items-center', 'space-x-2');
            loadingMessage.innerHTML = `
                <div class="loader-container h-6 w-16">
                    <div class="loader-dot bg-violet-400"></div>
                    <div class="loader-dot bg-violet-400"></div>
                    <div class="loader-dot bg-violet-400"></div>
                </div>
                <span class="text-gray-400 dark:text-gray-300">AI is thinking...</span>
            `;
            chatHistoryDiv.appendChild(loadingMessage);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            
            try {
                // Call API with full chat history
                const payload = {
                    contents: chatHistory,
                    // Add generationConfig with temperature
                    generationConfig: {
                        temperature: GEMINI_TEMPERATURE,
                    },
                };
                
                const responseText = await callGeminiAPI(payload);
                
                // Append AI response to chat history and UI
                chatHistory.push({ role: 'model', parts: [{ text: responseText }] });
                // Pass a unique ID for the message for feedback (in a real app, this would be from backend)
                appendChatMessage('ai', responseText, [], `msg-${chatHistory.length}`); 
                
            } catch (error) {
                console.error('Chat API call failed:', error);
                showError(`Cosmic communication breakdown: ${error.message}`);
            } finally {
                sendChatBtn.disabled = false;
                chatInput.disabled = false;
                chatFileUpload.disabled = false;
                modelSelect.disabled = false; // Re-enable model selection
                temperatureSelect.disabled = false; // Re-enable temperature selection
                versionSelect.disabled = false; // Re-enable version selection
                darkModeToggle.disabled = false; // Re-enable dark mode toggle
                voiceInputBtn.disabled = false; // Re-enable voice input
                const loadingDiv = document.getElementById('chat-loading');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
                chatInput.focus();
            }
        });
        
        // Add event listener for the 'Enter' key on the chat input
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { // Allow shift+enter for new line
                e.preventDefault(); // Prevent default enter behavior (new line in input)
                sendChatBtn.click();
            }
        });

        // Function to show a temporary message for clipboard copy
        function showCopyMessage() {
            copyMessage.classList.add('show');
            setTimeout(() => {
                copyMessage.classList.remove('show');
            }, 3000);
        }

        // Generic API call function with exponential backoff
        async function callGeminiAPI(payload) {
            // Use the currently selected model
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

            let response;
            let result;
            let success = false;
            let retryCount = 0;
            const maxRetries = 3;
            let delay = 1000; // 1 second initial delay

            while (retryCount < maxRetries && !success) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) { // Too many requests
                        if (retryCount < maxRetries - 1) {
                            console.warn(`API rate limit exceeded. Retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; // Exponential backoff
                            retryCount++;
                        } else {
                            throw new Error('API rate limit exceeded. Please try again later.');
                        }
                    } else if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                    } else {
                        result = await response.json();
                        success = true;
                    }
                } catch (err) {
                    if (retryCount < maxRetries - 1) {
                        console.warn(`Fetch error: ${err.message}. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                        retryCount++;
                    } else {
                        throw err; // Re-throw the last error after max retries
                    }
                }
            }
            
            if (result && result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                // Return the text content from the response
                return result.candidates[0].content.parts[0].text;
            } else {
                // Handle cases where AI might block content or return empty response
                if (result && result.promptFeedback && result.promptFeedback.blockReason) {
                    throw new Error(`AI blocked content due to: ${result.promptFeedback.blockReason}. Please rephrase your query.`);
                }
                throw new Error('Failed to get a valid response from the AI. No candidates found or content is empty.');
            }
        }

        // --- Voice Typing Functionality ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true; // Keep listening
            recognition.interimResults = true; // Show results as they come in
            recognition.lang = 'en-US'; // Set default language

            let currentInterimTranscript = ''; // To hold the current interim speech

            recognition.onstart = () => {
                console.log('Voice recognition started.');
                isListening = true;
                voiceInputBtn.classList.add('active');
                voiceInputBtn.innerHTML = '<i data-lucide="mic-off" class="w-5 h-5"></i>';
                createIcons();
                chatInput.placeholder = "Listening... Speak now!";
                finalTranscript = chatInput.value.trim(); // Preserve existing text
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                // Update chat input with final transcript + current interim
                chatInput.value = finalTranscript + interimTranscript;
                chatInput.focus(); // Keep focus on input
                chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length); // Move cursor to end
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                voiceInputBtn.classList.remove('active');
                voiceInputBtn.innerHTML = '<i data-lucide="mic" class="w-5 h-5"></i>';
                createIcons();
                chatInput.placeholder = "Ask your cosmic question...";
                if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                    showError('Microphone permission denied. Please allow microphone access to use voice typing.');
                } else if (event.error === 'no-speech') {
                    // Don't show an error for no speech, just stop listening
                    console.log('No speech detected, recognition stopped.');
                } else {
                    showError(`Voice input error: ${event.error}`);
                }
            };

            recognition.onend = () => {
                console.log('Voice recognition ended.');
                isListening = false;
                voiceInputBtn.classList.remove('active');
                voiceInputBtn.innerHTML = '<i data-lucide="mic" class="w-5 h-5"></i>';
                createIcons();
                chatInput.placeholder = "Ask your cosmic question...";
                // Ensure the final transcript is in the input field
                chatInput.value = finalTranscript.trim();
            };

            voiceInputBtn.addEventListener('click', () => {
                if (isListening) {
                    recognition.stop();
                } else {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('Error starting speech recognition:', e);
                        showError('Could not start voice input. Please check microphone access.');
                    }
                }
            });

            // Disable voice input button if API key is missing
            if (GEMINI_API_KEY === "" || !GEMINI_API_KEY) {
                voiceInputBtn.disabled = true;
                voiceInputBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }

        } else {
            // SpeechRecognition not supported
            voiceInputBtn.disabled = true;
            voiceInputBtn.classList.add('opacity-50', 'cursor-not-allowed');
            voiceInputBtn.title = 'Voice input not supported by your browser.';
            console.warn('Web Speech API (SpeechRecognition) not supported in this browser.');
            // Optionally, show a message to the user
            // showError('Voice typing is not supported in your browser. Please use Chrome or Edge for this feature.');
        }

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
