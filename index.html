<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Chatbot AI</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js CDN for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Lucide Icons for a modern, futuristic feel -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /*
         * --- Custom Styles for Cosmic Chatbot AI ---
         * This section defines the AMOLED black and galactic/cosmic theme,
         * ensuring a stunning and user-friendly experience across devices.
         */
        
        /* Basic font and transition settings for the whole page */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.4s ease, color 0.4s ease;
            height: 100vh; /* Ensure full viewport height */
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        /* Defining a vibrant, cosmic color palette using CSS variables */
        :root {
            /* Dark mode (default) colors for AMOLED black and cosmic theme */
            --bg-color-dark: #000000; /* Pure AMOLED black */
            --card-bg-dark: #1a0f2b; /* Deep violet/blue for cards/chat bubbles */
            --text-color-dark: #e0e7ff; /* Light blue-white for main text */
            --border-color-dark: #372a4d; /* Subtle dark border */
            
            /* Light mode colors (if toggled, for contrast) */
            --bg-color-light: #f0f4f8;
            --card-bg-light: #ffffff;
            --text-color-light: #1f2937;
            --border-color-light: #e5e7eb;
            
            /* Accent colors for buttons, highlights, etc. (cosmic vibrancy) */
            --accent-primary: #a78bfa; /* Vibrant purple */
            --accent-secondary: #0ea5e9; /* Electric blue */
            --accent-tertiary: #10b981; /* Glowing green for success */
            --accent-error: #ef4444; /* Clear red for errors */
        }
        
        /* Apply colors based on light or dark body class */
        body.light {
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
        }

        body.dark {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        /* Tailwind overrides for dark mode to ensure consistency */
        body.dark .bg-white { background-color: var(--card-bg-dark); }
        body.dark .bg-gray-50 { background-color: #11091e; } /* Even darker for header/footer */
        body.dark .border-gray-100 { border-color: var(--border-color-dark); }
        body.dark .border-gray-200 { border-color: #2e243f; }
        body.dark .text-gray-800, body.dark .text-gray-900 { color: var(--text-color-dark); }
        body.dark .text-gray-600 { color: #a1a1aa; }
        body.dark .text-gray-700 { color: #c3c3c3; }
        body.dark .bg-gray-200 { background-color: #3f3f46; color: #f4f4f5; }
        body.dark .hover\:bg-gray-300:hover { background-color: #52525b; }
        body.dark .bg-gray-100 { background-color: #271a3d; } /* Darker for message bubbles */
        body.dark .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6); } /* Deeper shadow for AMOLED */
        
        /* Specific overrides for chat elements in dark mode */
        body.dark #chat-history { background-color: var(--bg-color-dark); } /* Make chat history full black */
        body.dark #chat-input { background-color: #1a0f2b; color: var(--text-color-dark); border-color: #372a4d; }
        body.dark #chat-input::placeholder { color: #8e889a; }
        body.dark #model-select { background-color: #1a0f2b; color: var(--text-color-dark); border-color: #372a4d; }
        body.dark #model-select option { background-color: #1a0f2b; color: var(--text-color-dark); }


        body.dark .bg-violet-600 { background-color: var(--accent-primary); } /* Changed to violet */
        body.dark .hover\:bg-violet-700:hover { background-color: #8b5cf6; } /* Slightly darker purple on hover */
        body.dark .focus\:ring-violet-300:focus { box-shadow: 0 0 0 4px rgba(167, 139, 250, 0.4); } /* Changed to violet */

        body.dark .bg-gray-400 { background-color: #4a4e58; } /* Darker gray for disabled states */
        body.dark .text-gray-400 { color: #9ca3af; } /* Lighter gray for disabled text */
        
        /* Custom styles for glowing effects on buttons and borders */
        .glow-button {
            position: relative;
            z-index: 10;
            transition: all 0.4s ease;
            box-shadow: 0 0 10px var(--accent-primary);
        }
        .glow-button:hover {
            box-shadow: 0 0 15px var(--accent-primary), 0 0 25px var(--accent-primary), 0 0 35px var(--accent-primary);
            transform: translateY(-2px);
        }
        .glow-border {
            box-shadow: 0 0 10px rgba(167, 139, 250, 0.5); /* Semi-transparent glow with primary accent */
        }
        
        /* Markdown content styling for better readability */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { font-weight: bold; margin-bottom: 0.75em; margin-top: 1.5em; line-height: 1.2; color: var(--accent-secondary); }
        .markdown-content h1 { font-size: 2.25rem; }
        .markdown-content h2 { font-size: 1.875rem; }
        .markdown-content h3 { font-size: 1.5rem; }
        .markdown-content ul, .markdown-content ol { list-style-position: inside; margin-left: 1.5em; margin-bottom: 1em; }
        .markdown-content li { margin-bottom: 0.5em; }
        .markdown-content strong { color: var(--accent-primary); }
        .markdown-content code {
            background-color: rgba(167, 139, 250, 0.1);
            color: var(--accent-primary);
            padding: 0.2em 0.4em;
            border-radius: 0.3em;
            font-family: 'Fira Code', 'Monaco', 'Consolas', 'monospace';
            font-size: 0.9em;
        }
        .markdown-content pre {
            background-color: rgba(0, 0, 0, 0.4); /* Darker for code blocks */
            border-radius: 0.5rem;
            padding: 1em;
            overflow-x: auto;
            margin-top: 1em;
            margin-bottom: 1em;
        }
        .markdown-content pre code {
            background-color: transparent;
            color: #d4d4d8; /* Light grey for code */
            padding: 0;
            font-size: 1em;
        }
        .markdown-content blockquote {
            border-left: 4px solid var(--accent-secondary);
            color: #b0b0b0;
            padding-left: 1em;
            margin: 1em 0;
            font-style: italic;
        }

        /* Custom styles for dark mode toggle switch */
        .slider {
            background-color: #d1d5db;
            transition: .4s;
        }
        .dark .slider {
            background-color: #4b5563;
        }
        .slider:before {
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: var(--accent-secondary);
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* Custom scrollbar for a sleek look */
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: #1a0f2b; border-radius: 4px; } /* Match card-bg-dark */
        #chat-history::-webkit-scrollbar-thumb { background: #4a3a6b; border-radius: 4px; } /* Slightly lighter purple */
        #chat-history::-webkit-scrollbar-thumb:hover { background: #6b5a8c; } /* Even lighter on hover */
        
        /* Modern loading animation */
        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .loader-dot {
            width: 12px;
            height: 12px;
            margin: 0 4px;
            background-color: var(--accent-primary);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loader-dot:nth-child(1) { animation-delay: -0.32s; }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; }
        .loader-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }
        
        /* Chat message styles */
        .chat-message {
            margin-bottom: 0.75rem; /* 12px */
            padding: 1rem; /* 16px */
            border-radius: 1.5rem; /* 24px */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            word-break: break-word;
            transition: all 0.3s ease;
            transform: scale(0.95);
            transform-origin: bottom;
            max-width: 85%;
            line-height: 1.5;
        }

        .chat-message.user {
            background-color: #372a4d; /* Darker violet for user */
            color: #d1c0ed; /* Lighter purple for user text */
            margin-left: auto;
            border-bottom-right-radius: 0.5rem; /* 8px */
            border: 1px solid rgba(167, 139, 250, 0.2);
            box-shadow: 0 0 10px rgba(167, 139, 250, 0.1);
        }
        .chat-message.ai {
            background-color: #1a0f2b; /* Deep violet for AI */
            color: var(--text-color-dark);
            margin-right: auto;
            border-bottom-left-radius: 0.5rem; /* 8px */
            border: 1px solid rgba(14, 165, 233, 0.2);
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.1);
        }
        body.light .chat-message.user {
            background-color: #e0f2fe; /* Light blue */
            color: #1e40af; /* Dark blue */
            border: none;
            box-shadow: none;
        }
        body.light .chat-message.ai {
            background-color: #f3f4f6; /* Light gray */
            color: #374151; /* Dark gray */
            border: none;
            box-shadow: none;
        }

        /* Styling for chat attachments */
        .chat-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            margin-top: 0.5rem;
            display: block;
            border: 1px solid var(--border-color-dark);
        }
        
        /* Styling for the copy message */
        #copy-message {
            position: fixed;
            bottom: 6rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            background-color: var(--accent-tertiary);
            color: white;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease-in-out;
            z-index: 100;
        }

        #copy-message.show {
            opacity: 1;
            visibility: visible;
        }

        /* Ensure main content takes available height */
        .main-chat-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* Allow it to grow and fill space */
            padding: 0 1rem; /* Reduced horizontal padding on main container */
            max-width: 100%;
            overflow: hidden; /* Prevent horizontal scroll */
        }

        /* Responsive adjustments for header/footer */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: center; /* Center items in column mode */
            }
            .header-content > div { /* Target direct children of header-content */
                width: 100%; /* Make sure children take full width */
                text-align: center;
            }
            .header-content .flex { /* Specific for the right-side controls */
                justify-content: center; /* Center the mode toggle and model select */
                margin-top: 1rem;
            }
            .header-content .mb-4 {
                margin-bottom: 1rem; /* Add some space below title */
            }
            /* Reduce padding on the input container for smaller screens */
            .input-area-container {
                padding: 0.5rem; /* p-2 */
            }
            /* Ensure the chat input can shrink further */
            #chat-input {
                min-width: 0; /* Allow flex item to shrink below its content size */
            }
            .model-selector-group {
                flex-direction: column; /* Stack model selector and label on small screens */
                align-items: center;
            }
            .model-selector-group label {
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body class="antialiased dark">

    <!-- Main container for the full-screen chatbot -->
    <div class="main-chat-container max-w-4xl mx-auto w-full bg-transparent">
            
        <!-- Header Section with Title, Dark Mode Toggle, and Model Selector -->
        <header class="header-content flex flex-col md:flex-row justify-between items-center px-4 md:px-6 py-4 border-b border-gray-700 dark:border-gray-800 bg-gray-50 dark:bg-gray-800 rounded-t-xl mb-4">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 dark:text-gray-50 tracking-tight flex items-center justify-center md:justify-start">
                    <i data-lucide="sparkles" class="w-8 h-8 md:w-10 md:h-10 text-violet-400 mr-2 animate-pulse"></i>
                    Cosmic Chat AI
                </h1>
                <p class="text-md md:text-lg text-gray-600 dark:text-gray-400 mt-1">
                    Your intelligent companion across the digital cosmos.
                </p>
            </div>
            <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4 mt-4 md:mt-0">
                <!-- Model Selection -->
                <div class="flex items-center model-selector-group">
                    <label for="model-select" class="mr-2 text-gray-500 text-sm">Model:</label>
                    <select id="model-select" class="p-2 rounded-md border border-gray-600 dark:bg-gray-900 dark:border-gray-700 dark:text-white text-sm focus:ring-violet-500 focus:border-violet-500">
                        <option value="gemini-2.5-flash">gemini-2.5-flash</option>
                        <option value="gemini-2.5-flash-preview-05-20" selected>gemini-2.5-flash-preview-05-20</option>
                        <option value="gemini-2.5-pro">gemini-2.5-pro</option>
                    </select>
                </div>

                <!-- Dark Mode Toggle -->
                <div class="flex items-center space-x-2">
                    <span class="text-gray-500 text-sm">Light</span>
                    <label class="switch relative inline-block w-14 h-8">
                        <input type="checkbox" id="dark-mode-toggle" class="opacity-0 w-0 h-0">
                        <span class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 rounded-full before:absolute before:content-[''] before:h-6 before:w-6 before:left-1 before:bottom-1 before:rounded-full"></span>
                    </label>
                    <span class="text-gray-500 text-sm">Dark</span>
                </div>
            </div>
        </header>

        <!-- Chat history div with a minimum height and scroll -->
        <div id="chat-history" class="p-4 overflow-y-auto flex-1 flex flex-col rounded-b-xl border border-gray-700 dark:border-gray-800 bg-black shadow-inner-xl mb-4">
            <div class="flex flex-col items-center justify-center h-full text-center text-gray-500 dark:text-gray-600 mb-8 initial-message">
                <i data-lucide="message-circle" class="w-16 h-16 mb-4 text-violet-500"></i>
                <p class="text-lg font-semibold">Start your cosmic journey by sending a message!</p>
                <p class="text-sm mt-2">You can ask questions, upload files, or just say hello.</p>
            </div>
        </div>
        
        <!-- Chat input section with attachment and send button -->
        <div class="input-area-container p-2 sm:p-4 border-t border-gray-700 dark:border-gray-800 bg-gray-50 dark:bg-gray-800 rounded-xl mt-auto">
            <!-- Attachment preview -->
            <div id="chat-attachments-preview-container" class="mb-2 flex flex-wrap items-center gap-2 hidden">
                <!-- Attachments previews will be dynamically added here -->
            </div>
            <div class="flex gap-2">
                <input type="text" id="chat-input" class="flex-1 p-3 rounded-full border border-gray-600 focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition-colors shadow-sm dark:bg-gray-900 dark:border-gray-700 dark:text-white" placeholder="Ask your cosmic question...">
                <label for="chat-file-upload" class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-700 text-gray-200 shadow-lg hover:bg-gray-600 cursor-pointer transition-all duration-300 flex-shrink-0">
                    <i data-lucide="paperclip" class="w-5 h-5"></i>
                </label>
                <input type="file" id="chat-file-upload" accept="*" class="hidden" multiple>
                <button id="send-chat-btn" aria-label="Send Message" class="flex items-center justify-center w-12 h-12 rounded-full bg-violet-600 text-white shadow-lg hover:bg-violet-700 focus:outline-none focus:ring-4 focus:ring-violet-300 transition-all duration-300 disabled:bg-violet-400 disabled:cursor-not-allowed glow-button flex-shrink-0" style="--accent-primary: var(--accent-primary);">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Footer Section -->
    <footer class="text-center text-gray-600 dark:text-gray-500 text-xs py-2 px-4 mt-auto">
        <p>&copy; 2023 Cosmic Chat AI. All rights reserved.</p>
        <p class="mt-0.5">Powered by Gemini AI</p>
    </footer>

    <!-- Temporary message for clipboard copy -->
    <div id="copy-message">Text copied to clipboard!</div>


    <script type="text/javascript">
        // JavaScript for handling chat functionality and API interaction
        
        // This function call is from the Lucide Icon library to replace all `<i>` tags with the corresponding SVG icons
        const createIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        window.addEventListener('load', () => {
             // Create icons on initial page load for the main UI
             createIcons();
        });

        // Chat elements
        const chatHistoryDiv = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const chatFileUpload = document.getElementById('chat-file-upload'); // Changed ID for clarity
        const chatAttachmentsPreviewContainer = document.getElementById('chat-attachments-preview-container');
        
        // Dark Mode elements
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        
        // Model Selection elements
        const modelSelect = document.getElementById('model-select');

        // Copy message element
        const copyMessage = document.getElementById('copy-message');

        let chatAttachments = []; // Array to store {file: File, mimeType: string, data: string, name: string} for chat
        let chatHistory = []; // Stores the full conversation for context

        // Gemini API Configuration
        // WARNING: Hardcoding API keys in client-side code is NOT recommended for production environments
        // as it exposes your key to anyone who inspects your page. For a production-grade app,
        // you should proxy your API requests through a secure backend server.
        const GEMINI_API_KEY = "AIzaSyCzx6ReMk8ohPJcCjGwHHzu7SvFccJqAbA"; 
        
        // Initialize GEMINI_MODEL from the default selected option in the HTML
        let GEMINI_MODEL = modelSelect.value; 

        if (GEMINI_API_KEY === "" || !GEMINI_API_KEY) {
            console.error("API Key is not set. Please replace 'AIzaSyCzx6ReMk8ohPJcCjGwHHzu7SvFccJqAbA' with your actual API key.");
            // Display a more prominent error if API key is missing
            const apiKeyError = document.createElement('div');
            apiKeyError.classList.add('chat-message', 'ai', 'bg-red-800', 'text-red-100', 'border-red-600', 'my-4');
            apiKeyError.innerHTML = `<span class="font-bold"><i data-lucide="alert-triangle" class="w-4 h-4 mr-1 inline-block"></i> Critical Error:</span> Gemini API Key is missing or invalid. Please check the 'GEMINI_API_KEY' variable in the script. Chat functionality is disabled.`;
            chatHistoryDiv.insertBefore(apiKeyError, chatHistoryDiv.firstChild);
            chatHistoryDiv.scrollTop = 0; // Show error at top
            createIcons();

            sendChatBtn.disabled = true;
            chatInput.disabled = true;
            chatFileUpload.disabled = true;
            modelSelect.disabled = true; // Disable model selection if API key is bad
        }

        // Dark Mode Initialization and Listener
        // Set dark mode as default if not already set in local storage
        if (localStorage.getItem('dark-mode') === null) {
            localStorage.setItem('dark-mode', 'true');
        }
        
        const isDarkMode = localStorage.getItem('dark-mode') === 'true';
        if (isDarkMode) {
            document.body.classList.add('dark');
            darkModeToggle.checked = true;
        } else {
            document.body.classList.remove('dark');
            darkModeToggle.checked = false;
        }

        darkModeToggle.addEventListener('change', () => {
            if (darkModeToggle.checked) {
                document.body.classList.add('dark');
                localStorage.setItem('dark-mode', 'true');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem('dark-mode', 'false');
            }
        });

        // Event listener for model selection change
        modelSelect.addEventListener('change', (event) => {
            GEMINI_MODEL = event.target.value;
            console.log(`Gemini model changed to: ${GEMINI_MODEL}`);
            // Optionally, clear chat history when model changes to avoid context issues
            // chatHistory = [];
            // chatHistoryDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center text-gray-500 dark:text-gray-600 mb-8 initial-message">
            //     <i data-lucide="message-circle" class="w-16 h-16 mb-4 text-violet-500"></i>
            //     <p class="text-lg font-semibold">Chat history cleared. Start fresh with ${GEMINI_MODEL}!</p>
            //     <p class="text-sm mt-2">You can ask questions, upload files, or just say hello.</p>
            // </div>`;
            // createIcons();
        });


        // Function to convert a file to a Base64 string and return its MIME type and data
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({
                    mimeType: file.type || 'application/octet-stream', // Fallback MIME type
                    data: reader.result.split(',')[1]
                });
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        // Function to get Lucide icon name based on MIME type
        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'image';
            if (mimeType === 'application/pdf') return 'file-text';
            if (mimeType.includes('text/plain') || mimeType.includes('text/markdown')) return 'file-text';
            if (mimeType.includes('csv') || mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'file-spreadsheet';
            if (mimeType.includes('json') || mimeType.includes('xml') || mimeType.includes('code')) return 'file-code';
            if (mimeType.includes('audio/')) return 'file-audio';
            if (mimeType.includes('video/')) return 'file-video';
            if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('tar')) return 'file-archive';
            return 'file'; // Generic file icon
        }

        // Function to display an error message (for critical errors)
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.classList.add('chat-message', 'ai', 'bg-red-800', 'text-red-100', 'border-red-600');
            errorDiv.innerHTML = `<span class="font-bold"><i data-lucide="alert-triangle" class="w-4 h-4 mr-1 inline-block"></i> Error:</span> ${message}`;
            chatHistoryDiv.appendChild(errorDiv);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            createIcons(); // Ensure error icon is rendered
        }
        
        // Function to append a message to the chat history
        function appendChatMessage(role, text, attachments = []) { // attachments is now an array of {mimeType, data, name}
            // Remove the initial prompt if it exists
            const initialPromptDiv = chatHistoryDiv.querySelector('.initial-message');
            if (initialPromptDiv) {
                initialPromptDiv.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', role);
            
            let contentHTML = '';

            if (role === 'user') {
                contentHTML += `<span class="font-bold">You:</span> ${text}`;
                if (attachments.length > 0) {
                    contentHTML += `<div class="mt-2 flex flex-wrap gap-2">`;
                    attachments.forEach(attachment => {
                        if (attachment.mimeType.startsWith('image/')) {
                            contentHTML += `<img src="data:${attachment.mimeType};base64,${attachment.data}" alt="${attachment.name || 'User attachment'}" class="chat-image w-24 h-24 object-cover">`;
                        } else {
                            // For non-image files, display an icon and file name
                            contentHTML += `
                                <div class="flex items-center space-x-1 p-2 bg-gray-600 dark:bg-gray-700 rounded-md text-sm">
                                    <i data-lucide="${getFileIcon(attachment.mimeType)}" class="w-4 h-4 flex-shrink-0 text-gray-300"></i>
                                    <span class="truncate max-w-[120px]">${attachment.name || 'File'}</span>
                                </div>
                            `;
                        }
                    });
                    contentHTML += `</div>`;
                }
            } else { // AI message
                contentHTML = marked.parse(text);
            }
            
            messageDiv.innerHTML = contentHTML;
            chatHistoryDiv.appendChild(messageDiv);
            
            // Animate message pop-in
            setTimeout(() => {
                messageDiv.style.transform = 'scale(1)';
            }, 10);
            
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            
            // Call createIcons() after adding new content to the chat history
            createIcons();
        }

        // Event listener for chat file upload input
        chatFileUpload.addEventListener('change', async (event) => {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                for (const file of files) {
                    try {
                        const { mimeType, data } = await fileToBase64(file);
                        chatAttachments.push({ file, mimeType, data, name: file.name });
                    } catch (error) {
                        showError(`Failed to read chat file ${file.name}.`);
                        console.error('Chat file read error:', error);
                    }
                }
                displayChatAttachments();
                chatInput.focus();
            }
        });

        // Function to display chat attachments
        function displayChatAttachments() {
            chatAttachmentsPreviewContainer.innerHTML = '';
            if (chatAttachments.length > 0) {
                chatAttachmentsPreviewContainer.classList.remove('hidden');
                chatAttachments.forEach((attachment, index) => {
                    const attachmentDiv = document.createElement('div');
                    attachmentDiv.classList.add('flex', 'items-center', 'gap-1', 'p-2', 'rounded-md', 'bg-gray-700', 'text-gray-200', 'text-sm', 'border', 'border-gray-600');
                    attachmentDiv.dataset.index = index;

                    let previewContent = '';
                    if (attachment.mimeType.startsWith('image/')) {
                        previewContent = `<img src="data:${attachment.mimeType};base64,${attachment.data}" alt="${attachment.name}" class="w-10 h-10 object-cover rounded-md">`;
                    } else {
                        previewContent = `<i data-lucide="${getFileIcon(attachment.mimeType)}" class="w-5 h-5 flex-shrink-0 text-gray-300"></i>`;
                    }

                    attachmentDiv.innerHTML = `
                        ${previewContent}
                        <span class="truncate max-w-[100px]">${attachment.name}</span>
                        <button class="remove-attachment-btn text-gray-400 hover:text-white transition-colors p-1 rounded-full hover:bg-gray-600 ml-1">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    `;
                    chatAttachmentsPreviewContainer.appendChild(attachmentDiv);
                });
                createIcons(); // Re-render icons for new attachments
            } else {
                chatAttachmentsPreviewContainer.classList.add('hidden');
            }
        }

        // Event listener for removing individual chat attachments
        chatAttachmentsPreviewContainer.addEventListener('click', (event) => {
            if (event.target.closest('.remove-attachment-btn')) {
                const attachmentDiv = event.target.closest('[data-index]');
                if (attachmentDiv) {
                    const index = parseInt(attachmentDiv.dataset.index);
                    chatAttachments.splice(index, 1); // Remove from array
                    displayChatAttachments(); // Re-render preview
                    chatInput.focus();
                }
            }
        });

        // Event listener for sending chat messages
        sendChatBtn.addEventListener('click', async () => {
            if (sendChatBtn.disabled) return; // Prevent double clicks during processing

            const userMessage = chatInput.value.trim();
            if (!userMessage && chatAttachments.length === 0) {
                return;
            }
            
            // Build the parts for the user message
            const userParts = [];
            if (userMessage) {
                userParts.push({ text: userMessage });
            }
            chatAttachments.forEach(attachment => {
                userParts.push({
                    inlineData: {
                        mimeType: attachment.mimeType,
                        data: attachment.data
                    }
                });
            });

            // Append user message and attachments to chat history and UI
            chatHistory.push({ role: 'user', parts: userParts });
            appendChatMessage('user', userMessage, chatAttachments);
            
            // Clear input and attachment after sending
            chatInput.value = '';
            chatAttachments = [];
            chatFileUpload.value = ''; // Clear file input
            displayChatAttachments(); // Clear attachment previews
            
            sendChatBtn.disabled = true;
            chatInput.disabled = true;
            chatFileUpload.disabled = true;
            modelSelect.disabled = true; // Disable model selection during API call
            
            // Show loading indicator
            const loadingMessage = document.createElement('div');
            loadingMessage.id = 'chat-loading';
            loadingMessage.classList.add('chat-message', 'ai', 'flex', 'items-center', 'space-x-2');
            loadingMessage.innerHTML = `
                <div class="loader-container h-6 w-16">
                    <div class="loader-dot bg-violet-400"></div>
                    <div class="loader-dot bg-violet-400"></div>
                    <div class="loader-dot bg-violet-400"></div>
                </div>
                <span class="text-gray-400 dark:text-gray-300">AI is thinking...</span>
            `;
            chatHistoryDiv.appendChild(loadingMessage);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            
            try {
                // Call API with full chat history
                const payload = {
                    contents: chatHistory,
                };
                
                const responseText = await callGeminiAPI(payload);
                
                // Append AI response to chat history and UI
                chatHistory.push({ role: 'model', parts: [{ text: responseText }] });
                appendChatMessage('ai', responseText);
                
            } catch (error) {
                console.error('Chat API call failed:', error);
                showError(`Cosmic communication breakdown: ${error.message}`);
            } finally {
                sendChatBtn.disabled = false;
                chatInput.disabled = false;
                chatFileUpload.disabled = false;
                modelSelect.disabled = false; // Re-enable model selection
                const loadingDiv = document.getElementById('chat-loading');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
                chatInput.focus();
            }
        });
        
        // Add event listener for the 'Enter' key on the chat input
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { // Allow shift+enter for new line
                e.preventDefault(); // Prevent default enter behavior (new line in input)
                sendChatBtn.click();
            }
        });

        // Function to show a temporary message for clipboard copy
        function showCopyMessage() {
            copyMessage.classList.add('show');
            setTimeout(() => {
                copyMessage.classList.remove('show');
            }, 3000);
        }

        // Generic API call function with exponential backoff
        async function callGeminiAPI(payload) {
            // Use the currently selected model
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

            let response;
            let result;
            let success = false;
            let retryCount = 0;
            const maxRetries = 3;
            let delay = 1000; // 1 second initial delay

            while (retryCount < maxRetries && !success) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) { // Too many requests
                        if (retryCount < maxRetries - 1) {
                            console.warn(`API rate limit exceeded. Retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; // Exponential backoff
                            retryCount++;
                        } else {
                            throw new Error('API rate limit exceeded. Please try again later.');
                        }
                    } else if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                    } else {
                        result = await response.json();
                        success = true;
                    }
                } catch (err) {
                    if (retryCount < maxRetries - 1) {
                        console.warn(`Fetch error: ${err.message}. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                        retryCount++;
                    } else {
                        throw err; // Re-throw the last error after max retries
                    }
                }
            }
            
            if (result && result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                // Return the text content from the response
                return result.candidates[0].content.parts[0].text;
            } else {
                // Handle cases where AI might block content or return empty response
                if (result && result.promptFeedback && result.promptFeedback.blockReason) {
                    throw new Error(`AI blocked content due to: ${result.promptFeedback.blockReason}. Please rephrase your query.`);
                }
                throw new Error('Failed to get a valid response from the AI. No candidates found or content is empty.');
            }
        }
    </script>
</body>
</html>